# 依赖和使用


## 目录
* [CentOS7安装Python](#centos7安装python)
  * [源码安装](#源码安装)
    * [安装编译相关工具](#安装编译相关工具)
    * [下载安装包解压](#下载安装包解压)
    * [编译安装](#编译安装)
    * [创建软连接](#创建软连接)
    * [验证是否成功](#验证是否成功)
    * [安装后`yum`不能正常使用](#安装后yum不能正常使用)
  * [yum安装Python3.6](#yum安装python36)
    * [安装`EPEL`和`IUS`软件源](#安装epel和ius软件源)
    * [安装Python3.6](#安装python36)
    * [创建python3连接符](#创建python3连接符)
    * [安装pip3](#安装pip3)
    * [创建pip3链接符](#创建pip3链接符)
* [pip](#pip)
  * [生成`requirements.txt`依赖管理文件](#生成requirementstxt依赖管理文件)
  * [根据`requirements.txt`安装依赖](#根据requirementstxt安装依赖)
  * [更新](#更新)
  * [换源](#换源)
    * [临时使用](#临时使用)
    * [永久修改](#永久修改)
* [打包](#打包)
  * [`PyInstalle`](#pyinstalle)
    * [安装](#安装)
    * [生成单文件](#生成单文件)
    * [生成安装目录](#生成安装目录)
    * [其他参数](#其他参数)
  * [`py2exe`](#py2exe)
    * [`setup.py`](#setuppy)




## CentOS7安装Python

### 源码安装
> 全部操作都在`root`用户下执行

#### 安装编译相关工具
```bash
yum -y groupinstall "Development tools"
yum -y install zlib-devel bzip2-devel openssl-devel \
 ncurses-devel sqlite-devel readline-devel tk-devel \
 gdbm-devel db4-devel libpcap-devel xz-devel libffi-devel
```
#### 下载安装包解压
> 到官网复制最新版下载地址 https://www.python.org/downloads/release

```bash
wget https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tar.xz
# 解压
tar -xvJf Python-3.7.3.tar.xz
# 切换到解压目录
cd Python-3.7.3
```
#### 编译安装
```bash
# 创建编译安装目录，并配置指定安装路径
mkdir /usr/local/python3 && ./configure --prefix=/usr/local/python3
# 编译安装并把安装日志保存下来
make && make install > install.log
```
#### 创建软连接
```bash
ln -s /usr/local/python3/bin/python3 /bin/python3
ln -s /usr/local/python3/bin/pip3 /bin/pip3
```
#### 验证是否成功
```bash
python3 -V && pip3 -V
```

#### 安装后`yum`不能正常使用
- 把 `#!/usr/bin/python` 修改为 `#!/usr/bin/python2`
 
```bash
vi /usr/bin/yum 
```
- 把 `#!/usr/bin/python` 修改为 `#!/usr/bin/python2`

```bash
vi /usr/libexec/urlgrabber-ext-down 
```



### yum安装Python3.6
#### 安装`EPEL`和`IUS`软件源
```bash
yum -y install epel-release
yum -y install https://centos7.iuscommunity.org/ius-release.rpm
```
#### 安装Python3.6
```bash
yum -y install python36u
```

#### 创建python3连接符
```bash
ln -s /bin/python3.6 /bin/python3
```

#### 安装pip3
```bash
yum -y install python36u-pip
```
#### 创建pip3链接符
```bash
ln -s /bin/pip3.6 /bin/pip3
```


## pip
### 生成`requirements.txt`依赖管理文件
```bash
pip freeze > requirements.txt
``` 

### 根据`requirements.txt`安装依赖
```bash
pip install -r requirements.txt
```

### 更新
```bash
python -m pip install --upgrade pip
pip install --upgrade setuptools
pip install --user numpy scipy matplotlib jupyter pandas sympy nose
```

- 解决pip安装模块提示已经安装更高版本问题
```bash
pip3 install --ignore-installed 模块名
```

### 换源

* [https://pypi.org/](https://pypi.org/)

```
阿里云 https://mirrors.aliyun.com/pypi/simple
中国科技大学 https://pypi.mirrors.ustc.edu.cn/simple
清华大学 https://pypi.tuna.tsinghua.edu.cn/simple

豆瓣(douban) http://pypi.douban.com/simple
中国科学技术大学 http://pypi.mirrors.ustc.edu.cn/simple
华中理工大学：http://pypi.hustunique.com
山东理工大学：http://pypi.sdutlinux.org
```
#### 临时使用
> 可以在使用pip的时候加参数`-i 网址`
>
> 注意如果不是`https`协议网址需要加`--trusted-host`参数

```bash
pip install -i http://pypi.douban.com/simple --trusted-host pypi.douban.com requests
```

#### 永久修改

- 使用命令
```batch
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```


- 编辑文件
```bash
# Linux环境
vi ~/.pip/pip.conf 
# windows环境
%APPDATA%\Romaing\pip\pip.ini
```

- 添加或者修改

```bash
[global]
index-url = http://mirrors.aliyun.com/pypi/simple/
[install]
trusted-host=mirrors.aliyun.com
```





## 打包
### `PyInstalle`

> PyInstaller 是一个十分有用的第三方库，可以用来打包`Python`应用程序，打包完的程序就可以在没有安装`Python`解释器的机器上运行了。
>
> 它能够在`Windows`、`Linux`、`Mac OS X`等操作系统下将`Python`源文件打包，通过对源文件打包，
> `Python`程序可以在没有安装`Python`的环境中运行，也可以作为一个独立文件方便传递和管理。

> `PyInstaller`支持`Python 2.7`和`Python 3.4 +`。可以在`Windows`、`Mac OS X`和`Linux`上使用，
> 但是并不是跨平台的，而是说你要是希望打包成`.exe`文件，需要在`Windows`系统上运行`PyInstaller`进行打包工作。

[https://hoxis.github.io/python-pyinstaller.html](https://hoxis.github.io/python-pyinstaller.html)

#### 安装
```bash
pip install pyinstaller
```
#### 生成单文件
```bash
pyinstaller -F app.py
# windows打包为运行不显示命令行窗口的程序
pyinstaller -F -w -n=BajinsWallpaper app.py
```
#### 生成安装目录
> 此方式可借用其他第三方封包工具封装为exe安装程序，比如`NSIS`、`InnoSetup`
>
> 注意：执行命令前先将目录下`build`、`dist`目录删除，并将`spec`后缀的文件也删除

```bash
pyinstaller -D -w -n=BajinsWallpaper app.py
```
#### 其他参数
| -h      | --help                 | 查看该模块的帮助信息                                                                      |
|---------|------------------------|---------------------------------------------------------------------------------|
| -F      | -onefile               | 产生单个的可执行文件                                                                      |
| -D      | --onedir               | 产生一个目录（包含多个文件）作为可执行程序                                                           |
| -a      | --ascii                | 不包含Unicode字符集支持                                                                 |
| -D      | --debug                | 产生debug版本的可执行文件                                                                 |
| -w      | --windowed,--noconsolc | 指定程序运行时不显示命令行窗口（仅对Windows有效）                                                    |
| -c      | --nowindowed,--console | 指定使用命令行窗口运行程序（仅对Windows有效）                                                      |
| -o DIR  | --outDIR               | 指定spec文件的生成目录。如果没有指定，则默认使用当前目录来生成spec文件                                         |
| -p DIR  | --pathDIR              | 设置Python导入模块的路径（和设置PYTHONPATH环境变量的作用相似）。也可使用路径分隔符（Windows使用分号，Linux使用冒号）来分隔多个路径 |
| -n NAME | --NAMENAME             | 指定项目（产生的spec）名字。如果省略该选项，那么第一个脚本的主文件名将作为spec的名字                                  |


### `py2exe`

[http://www.py2exe.org/](http://www.py2exe.org/)

[https://hoxis.github.io/python-py2exe.html](https://hoxis.github.io/python-py2exe.html)

> `py2exe`是一个将`python`脚本转换成`Windows`上的可独立执行的可执行程序（`*.exe`）的工具，
> 这样就可以不用装`python`而在`Windows`系统上运行这个可执行程序

> `py2exe`新版本只支持`python3.3`以上，可以使用`pip install py2exe_py2`来安装兼容`python2`版本；
>
> 若在`python3.6`版本下运行报错，请切换到`python3.4`尝试；
>
> `python3`如果是`64 位`，生成的`exe`只能在`64 位`操作系统下运行，使用`32 位` `python`可以解决；
>
> 从`Python 3.3`，`Windows`在构建`Python`时使用的是`Visual Studio 2010`，因此生成后，
> 需要手动将`msvcr100.dll`拷到生成目录下（`dist`目录），否则最终的文件运行时可能会报错；
> 或者通过`data_files=[("",["MSVCR100.dll"])]`, 打包其中；


#### `setup.py`

```python

from distutils.core import setup
import py2exe
import sys
 
# 允许程序通过双击的形式执行。
sys.argv.append('py2exe')
 
py2exe_options = {
        # 需要包含的文件，这里的"sip"是PyQt程序打包时需要添加的，如果不是PyQt程序不需要此项。
        "includes": ["sip"],
        # 需要排除的dll文件，这里的"MSVCP90.dll"文件，
        # 如果不排除的话会报error: MSVCP90.dll: No such file or directory错误。
        "dll_excludes": ["MSVCP90.dll",],
        # 为1，则压缩文件
        "compressed": 1,
        # 为优化级别，默认为0。
        "optimize": 2,
        # 不自动包含encodings和codecs。
        "ascii": 0,
        """
        将程序打包成单文件（同时还会生成一个zip文件，可设置zipfile = None去除）。
        1：表示pyd和dll文件会被打包到单文件中，且不能从文件系统中加载python模块；
        2：表示pyd和dll文件会被打包到单文件中，但是可以从文件系统中加载python模块。
        64位的Py2exe不要添加本句。
        """
        "bundle_files": 1,
        }
 
setup(
      name = 'PyQt Demo',
      version = '1.0',
      """
      这里使用的是windows，即没有命令行窗口出现，如果使用console则表示有命令行窗口出现。
      "myico.ico"是程序图标
      """
      windows = [{ "script":'wordreplace.py',"icon_resources":[(1,"myico.ico")]}], 
      """
      把images目录中所有的jpg文件打包到dist/images子目录中。
      把public目录下的test.bat文件打包到dist/static子目录中。
      """
      data_files = [('images',['images\*.jpg']),('static',['public\\test.bat'])],
      # 如果没有此句，会生成一个`library.zip`文件。
      zipfile = None,
      options = {'py2exe': py2exe_options}
      )
```
> 执行该脚本，会得到一个build文件夹和一个dist文件夹。其中，dist文件夹，就是你得到的打包程序。

> 如果按照上述代码执行成功，则应该dist文件夹中，只包括程序的exe文件和`w9xpopen.exe`。`w9xpopen.exe`是针对`windows9x`版本的，
> 一般来说该文件并不需要。

> 如果`bundle_files`不为`1`、`2`，则`dist`文件夹中还会包括一些dll文件和pyd文件（`Python Dll`文件）。
> 如果`bundle_files`为`2`，`dist`文件夹会包括一个`python##.dll`文件，如果为1则不会。


## 其他

### 输入参数

```python
# host=input("请输入数据库IP地址：")
# port=input("请输入数据库端口：")
# user=input("请输入数据库用户名：")
# dbPasswd=input("请输入数据库密码：")
# database=input("请输入数据库名：")
# charset=input("请输入数据库字符编码：")
# dbSQL=input("请输入数据库查询SQL：")

# 设置参数
parser = argparse.ArgumentParser(description='manual to this script')
parser.add_argument('--host', '-host', type=str, default='localhost', help='请输入数据库IP地址')
parser.add_argument('--port', '-port', type=int, default=3306, help='请输入数据库端口')
parser.add_argument('--user', '-user', type=str, default='root', help='请输入数据库用户名')
parser.add_argument('--password', '-pwd', type=str, default=None, help='请输入数据库密码')
parser.add_argument('--database', '-db', type=str, default=None, help='请输入数据库名')
parser.add_argument('--charset', '-charset', type=str, default='UTF8', help='请输入数据库字符编码')

# 获取参数值
args = parser.parse_args()
host = args.host
port = args.port
user = args.user
password = args.password
database = args.database
charset = args.charset
```